<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Rail JSON 生成ツール（N02-20_Station.geojson → index.json / 路線別JSON）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; line-height: 1.6; margin: 20px; }
    textarea { width: 100%; height: 220px; }
    input[type="number"] { width: 140px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .btn { padding: 8px 14px; border: 1px solid #333; border-radius: 8px; background: #fff; cursor: pointer; }
    .btn:disabled { opacity: .4; cursor: not-allowed; }
    .log { background: #111; color: #0f0; padding: 10px; border-radius: 8px; white-space: pre-wrap; max-height: 360px; overflow: auto; }
    .downloads a { margin-right: 10px; }
    small code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; }
    label { user-select: none; }
  </style>
</head>
<body>
  <h1>Rail JSON 生成ツール</h1>
  <p>
    国土数値情報の <b>N02-20_Station.geojson</b>（駅データ）を下に貼り付けて「生成」を押すと、<br>
    <b>rail/hiroshima/index.json</b> と <b>路線ごとの JSON</b> をダウンロードできます。外部送信はありません。
  </p>

  <h3>1) GeoJSON（Station）を貼り付け</h3>
  <textarea id="geojson" placeholder="ここに N02-20_Station.geojson の内容を丸ごと貼り付け"></textarea>

  <h3>2) 抽出条件</h3>
  <div class="row">
    <label><input type="checkbox" id="useBbox" checked> BBOXを使う</label>
    <div>minLon: <input type="number" id="minLon" step="0.0001" value="131.5"></div>
    <div>minLat: <input type="number" id="minLat" step="0.0001" value="33.5"></div>
    <div>maxLon: <input type="number" id="maxLon" step="0.0001" value="133.5"></div>
    <div>maxLat: <input type="number" id="maxLat" step="0.0001" value="35.0"></div>
  </div>
  <div class="row" style="margin-top:6px;">
    <div>
      会社名フィルタ（任意・部分一致）:
      <input type="text" id="companyFilter" placeholder="例: 広島電鉄 / JR西日本 / アストラムライン">
    </div>
    <button id="presetHiroshima" class="btn" type="button">BBOXを広島県に設定</button>
  </div>

  <div class="row" style="margin-top:10px;">
    <button id="runBtn" class="btn">生成</button>
    <button id="clearBtn" class="btn" type="button">リセット</button>
  </div>

  <h3>ログ</h3>
  <div id="log" class="log" aria-live="polite"></div>

  <h3>ダウンロード</h3>
  <div id="downloads" class="downloads"></div>
  <p><small>保存先の目安：<code>rail/hiroshima/</code> 配下に置き、<code>index.json</code> は <code>/rail/hiroshima/index.json</code> で参照されるようにしてください。</small></p>

<script>
// ---------- 小物 ----------
const log = (...a) => { const el = document.getElementById('log'); el.textContent += '[tool] ' + a.join(' ') + '\n'; el.scrollTop = el.scrollHeight; };
const warn = (...a) => { const el = document.getElementById('log'); el.textContent += '[WARN] ' + a.join(' ') + '\n'; el.scrollTop = el.scrollHeight; };
const err  = (...a) => { const el = document.getElementById('log'); el.textContent += '[ERROR] ' + a.join(' ') + '\n'; el.scrollTop = el.scrollHeight; };

function downloadJSON(obj, filename) {
  const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.textContent = filename; a.className = 'btn';
  document.getElementById('downloads').appendChild(a);
  document.getElementById('downloads').appendChild(document.createTextNode(' '));
}

function slugify(s) {
  return String(s || '').normalize('NFKC')
    .replace(/[（）\(\)\s]/g, '_')
    .replace(/[^\w\-ァ-ン一-龥]/g, '_')
    .replace(/_+/g, '_')
    .replace(/^_|_$/g, '')
    .toLowerCase();
}

// 座標を堅牢に取り出す: Point/MultiPoint対応 + lon/lat自動判定
function extractLonLat(geom) {
  if (!geom) return null;
  let coords = null;
  if (geom.type === 'Point') coords = geom.coordinates;
  else if (geom.type === 'MultiPoint' && Array.isArray(geom.coordinates) && geom.coordinates.length) coords = geom.coordinates[0];
  if (!Array.isArray(coords) || coords.length < 2) return null;

  let x = Number(coords[0]), y = Number(coords[1]);
  if (!Number.isFinite(x) || !Number.isFinite(y)) return null;

  // 自動スワップ: もし x が緯度っぽく(<=90) かつ y が経度っぽい(>90)なら入替
  if (Math.abs(x) <= 90 && Math.abs(y) >= 90) {
    const t = x; x = y; y = t;
  }
  // あり得ない値は弾く
  if (Math.abs(x) > 180 || Math.abs(y) > 90) return null;

  return { lon: x, lat: y };
}

document.getElementById('presetHiroshima').addEventListener('click', () => {
  document.getElementById('minLon').value = '131.5';
  document.getElementById('minLat').value = '33.5';
  document.getElementById('maxLon').value = '133.5';
  document.getElementById('maxLat').value = '35.0';
  document.getElementById('useBbox').checked = true;
  log('BBOXを広島県プリセットに設定しました。');
});

document.getElementById('clearBtn').addEventListener('click', () => {
  document.getElementById('geojson').value = '';
  document.getElementById('companyFilter').value = '';
  document.getElementById('downloads').innerHTML = '';
  document.getElementById('log').textContent = '';
});

document.getElementById('runBtn').addEventListener('click', () => {
  const raw = document.getElementById('geojson').value.trim();
  if (!raw) { alert('GeoJSONを貼り付けてください'); return; }

  let gj;
  try {
    gj = JSON.parse(raw);
  } catch(e) {
    err('GeoJSONのJSONパースに失敗しました。'); return;
  }
  if (!gj || !Array.isArray(gj.features)) {
    err('FeatureCollection（features配列）ではありません。'); return;
  }

  const useBbox = document.getElementById('useBbox').checked;
  const minLon = parseFloat(document.getElementById('minLon').value);
  const minLat = parseFloat(document.getElementById('minLat').value);
  const maxLon = parseFloat(document.getElementById('maxLon').value);
  const maxLat = parseFloat(document.getElementById('maxLat').value);
  const companyFilter = document.getElementById('companyFilter').value.trim();

  const inBbox = (lon, lat) => (!useBbox) || (lon>=minLon && lon<=maxLon && lat>=minLat && lat<=maxLat);

  // 路線ごとにグループ化
  // N02 スキーマ（代表例）:
  //   N02_001: 事業者名（会社）
  //   N02_002: 路線名
  //   N02_003: 駅名
  const lines = new Map(); // key -> { code, name_ja, company, stations: [] }

  let total = 0, used = 0, firstSample = null;
  for (const f of gj.features) {
    total++;
    const p = f.properties || {};
    const pos = extractLonLat(f.geometry);
    if (!pos) continue;

    if (!inBbox(pos.lon, pos.lat)) continue;

    const company = p.N02_001 || p.company || p['会社名'] || '';
    const lineName = p.N02_002 || p.line || p['路線名'] || '';
    const station  = p.N02_003 || p.station || p['駅名'] || '';

    if (!lineName || !station) continue;
    if (companyFilter && !String(company).includes(companyFilter)) continue;

    const key = `${company}__${lineName}`;
    if (!lines.has(key)) {
      const slug = slugify(`${company}_${lineName}`) || 'line';
      lines.set(key, {
        code: slug,
        name_ja: String(lineName),
        company: String(company),
        stations: []
      });
    }
    lines.get(key).stations.push({
      name_ja: String(station),
      lon: pos.lon,
      lat: pos.lat
    });

    used++;
    if (!firstSample) firstSample = { company, lineName, station, lon: pos.lon, lat: pos.lat };
  }

  if (used === 0) {
    warn('BBOXやフィルタ条件に一致する駅が見つかりませんでした。まずは「BBOXを使う」をOFFにして再実行してください。');
  } else if (firstSample) {
    log(`採用サンプル: ${firstSample.company} / ${firstSample.lineName} / ${firstSample.station} @ (${firstSample.lon.toFixed(5)}, ${firstSample.lat.toFixed(5)})`);
  }

  // 路線ごとの重複駅除去・整列
  const lineFiles = [];
  for (const [, line] of lines) {
    const seen = new Set();
    const uniq = [];
    for (const s of line.stations) {
      const k2 = `${s.name_ja}|${s.lon.toFixed(6)}|${s.lat.toFixed(6)}`;
      if (seen.has(k2)) continue;
      seen.add(k2);
      uniq.push(s);
    }
    // 駅名でソート（厳密な運行順はRailway側参照が必要）
    uniq.sort((a,b)=> a.name_ja.localeCompare(b.name_ja,'ja'));

    const lineObj = {
      code: line.code,
      name_ja: line.name_ja,
      company: line.company || null,
      stations: uniq.map((s,idx)=>({
        code: `${line.code}-${String(idx+1).padStart(2,'0')}`,
        name_ja: s.name_ja,
        order: idx+1,
        lon: s.lon,
        lat: s.lat
      }))
    };

    const fileName = `${line.code}.json`;
    downloadJSON(lineObj, fileName);
    lineFiles.push({
      code: line.code,
      name_ja: line.name_ja,
      file: fileName,
      stationCount: lineObj.stations.length
    });
  }

  // index.json を出力（名前順）
  lineFiles.sort((a,b)=> a.name_ja.localeCompare(b.name_ja,'ja'));
  const indexOut = { lines: lineFiles };
  downloadJSON(indexOut, 'index.json');

  log(`総features=${total}, 採用stations=${used}, 路線数=${lineFiles.length}`);
  if (companyFilter) log(`会社フィルタ: "${companyFilter}" を適用しました`);
  log('完了。ダウンロードしたファイルを rail/hiroshima/ へ配置してください。');
});
</script>
</body>
</html>
