<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>JSON 整形ツール（広島市 区→町丁目）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; line-height: 1.6; margin: 20px; }
    textarea { width: 100%; height: 200px; }
    button { margin-top: 10px; padding: 8px 14px; }
    pre { background: #111; color: #0f0; padding: 10px; overflow: auto; }
    .downloads a { margin-right: 12px; }
  </style>
</head>
<body>
  <h1>JSON 整形ツール</h1>
  <p>CSVJSONで変換したJSON配列を下のテキストエリアに貼り付け、「整形」ボタンを押すと、<b>index.json / 34101.json / 34103.json</b> を生成してダウンロードできます。</p>

  <textarea id="input" placeholder="ここにCSVJSONの出力を貼り付け"></textarea>
  <br>
  <button id="runBtn">整形してダウンロード</button>

  <h3>ログ</h3>
  <pre id="log"></pre>

  <div class="downloads" id="downloads"></div>

<script>
function log(msg) {
  const el = document.getElementById('log');
  el.textContent += msg + "\n";
}

function downloadJSON(obj, filename) {
  const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.textContent = filename;
  document.getElementById("downloads").appendChild(a);
  document.getElementById("downloads").appendChild(document.createTextNode(" "));
}

document.getElementById("runBtn").addEventListener("click", () => {
  const inputText = document.getElementById("input").value.trim();
  if (!inputText) { alert("JSONを貼り付けてください"); return; }

  let data;
  try {
    data = JSON.parse(inputText);
  } catch (e) {
    alert("JSONの形式が正しくありません"); return;
  }

  // 区ごとに集約
  const TARGET_WARDS = { "34101": "中区", "34103": "南区" };
  const wards = {};

  data.forEach(row => {
    const code = row["市区町村コード"];
    if (!TARGET_WARDS[code]) return;

    const town = row["大字・町名"];
    const chome = row["字・丁目名"];
    if (!wards[code]) {
      wards[code] = { wardCode: code, wardName: TARGET_WARDS[code], towns: {} };
    }
    if (!wards[code].towns[town]) wards[code].towns[town] = new Set();
    if (chome) wards[code].towns[town].add(chome);
  });

  const indexOut = [];
  Object.keys(TARGET_WARDS).forEach(code => {
    const ward = wards[code] || { wardCode: code, wardName: TARGET_WARDS[code], towns: {} };
    const townsArr = Object.entries(ward.towns).map(([name, chomeSet]) => ({
      name,
      chome: Array.from(chomeSet).sort()
    }));
    const obj = { wardCode: ward.wardCode, wardName: ward.wardName, towns: townsArr };

    const fileName = `${code}.json`;
    downloadJSON(obj, fileName);
    log(`出力: ${fileName} towns=${townsArr.length}`);

    indexOut.push({ code: ward.wardCode, name: ward.wardName, path: `address/hiroshima/${fileName}`, townCount: townsArr.length });
  });

  downloadJSON({ wards: indexOut }, "index.json");
  log("出力: index.json");
});
</script>
</body>
</html>
