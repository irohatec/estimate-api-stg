<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>不動産アプリ デモ（広島）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="/style.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-3xl mx-auto p-6 space-y-6">
    <h1 class="text-2xl font-bold">不動産アプリ デモ（広島）</h1>

    <section class="p-4 bg-white rounded-xl shadow">
      <h2 class="font-semibold mb-3">① 住所を選択</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <label class="text-sm">市区</label>
          <select id="city" class="w-full p-2 border rounded"></select>
        </div>
        <div>
          <label class="text-sm">町</label>
          <select id="town" class="w-full p-2 border rounded"></select>
        </div>
        <div>
          <label class="text-sm">丁目</label>
          <select id="chome" class="w-full p-2 border rounded"></select>
        </div>
      </div>
      <div class="mt-3">
        <label class="text-sm">番地（例：1-2-3）※空なら駅必須</label>
        <input id="banchi" class="w-full p-2 border rounded" placeholder="例）1-2-3">
      </div>
    </section>

    <section class="p-4 bg-white rounded-xl shadow">
      <h2 class="font-semibold mb-3">② 最寄り駅</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm">路線</label>
          <select id="line" class="w-full p-2 border rounded"></select>
        </div>
        <div>
          <label class="text-sm">駅</label>
          <select id="station" class="w-full p-2 border rounded"></select>
        </div>
      </div>
      <p class="text-xs text-gray-600 mt-2">ルール：番地がある → 駅は任意 ／ 番地が空 → 駅は必須</p>
    </section>

    <section class="p-4 bg-white rounded-xl shadow">
      <h2 class="font-semibold mb-3">③ バリデーション</h2>
      <button id="validateBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">チェックする</button>
      <p id="validationMsg" class="mt-3 text-sm"></p>
    </section>

    <section class="p-4 bg-white rounded-xl shadow">
      <h2 class="font-semibold mb-3">④ プレビュー</h2>
      <pre id="preview" class="text-sm whitespace-pre-wrap"></pre>
    </section>
  </div>

  <script>
    const citySel = document.getElementById('city');
    const townSel = document.getElementById('town');
    const chomeSel = document.getElementById('chome');
    const lineSel = document.getElementById('line');
    const stationSel = document.getElementById('station');
    const banchiInput = document.getElementById('banchi');
    const validationMsg = document.getElementById('validationMsg');
    const previewEl = document.getElementById('preview');

    async function fetchJSON(url) {
      const res = await fetch(url, { cache: 'no-cache' });
      if (!res.ok) throw new Error(`Load failed: ${url} (${res.status})`);
      return res.json();
    }

    let addrIndex, linesIndex, currentCityData;

    async function init() {
      addrIndex = await fetchJSON('/address/hiroshima/index.json');
      linesIndex = await fetchJSON('/rail/hiroshima/index.json');

      // index.json の wards を cities に変換して使う
      citySel.innerHTML = '<option value="">選択してください</option>' +
        addrIndex.wards
          .map(c => `<option value="${c.path}">${c.name}</option>`)
          .join('');

      lineSel.innerHTML = '<option value="">選択してください</option>' +
        linesIndex.lines
          .map(l => `<option value="${l.code}" data-file="${l.file}">${l.name_ja}</option>`)
          .join('');

      updatePreview();
      citySel.focus();
    }

    citySel.addEventListener('change', async () => {
      const file = citySel.value;
      townSel.innerHTML = '';
      chomeSel.innerHTML = '';
      if (!file) return;
      currentCityData = await fetchJSON('/' + file);

      townSel.innerHTML = '<option value="">選択してください</option>' +
        currentCityData.towns.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
      chomeSel.innerHTML = '<option value="">（丁目なし/未選択）</option>';
      updatePreview();
    });

    townSel.addEventListener('change', () => {
      const selTown = townSel.value;
      chomeSel.innerHTML = '<option value="">（丁目なし/未選択）</option>';
      if (!selTown || !currentCityData) return updatePreview();
      const t = currentCityData.towns.find(x => x.name === selTown);
      if (t && t.chome && t.chome.length) {
        chomeSel.innerHTML = '<option value="">丁目を選択</option>' +
          t.chome.map(n => `<option value="${n}">${n}</option>`).join('');
      }
      updatePreview();
    });

    lineSel.addEventListener('change', async () => {
      stationSel.innerHTML = '';
      const file = lineSel.selectedOptions[0]?.dataset.file;
      if (!file) return;
      const lineData = await fetchJSON(`/rail/hiroshima/${file}`);
      stationSel.innerHTML = '<option value="">選択してください</option>' +
        lineData.stations.map(s => `<option value="${s.name_ja}">${s.name_ja}</option>`).join('');
      updatePreview();
    });

    stationSel.addEventListener('change', updatePreview);
    banchiInput.addEventListener('input', updatePreview);
    chomeSel.addEventListener('change', updatePreview);

    function validate() {
      const banchi = banchiInput.value.trim();
      const station = stationSel.value.trim();
      if (banchi === '' && station === '') {
        return { ok: false, msg: '番地が未入力のため、駅の選択が必須です。' };
      }
      return { ok: true, msg: 'OK：入力条件を満たしています。' };
    }

    function updatePreview() {
      const city = citySel.options[citySel.selectedIndex]?.text || '';
      const town = townSel.value || '';
      const chome = chomeSel.value || '';
      const banchi = banchiInput.value.trim();
      const line = lineSel.value ? lineSel.options[lineSel.selectedIndex].text : '';
      const station = stationSel.value || '';

      const obj = {
        address: { city, town, chome: chome || null, banchi: banchi || null },
        station: { line: line || null, name: station || null },
        rule: "番地があれば駅は任意／番地がなければ駅必須"
      };
      previewEl.textContent = JSON.stringify(obj, null, 2);
    }

    document.getElementById('validateBtn').addEventListener('click', () => {
      const r = validate();
      validationMsg.textContent = r.msg;
      validationMsg.className = r.ok ? "mt-3 text-green-700" : "mt-3 text-red-700";
    });

    init().catch(e => {
      console.error(e);
      validationMsg.textContent = '初期化エラー：' + e.message;
      validationMsg.className = "mt-3 text-red-700";
    });
  </script>
</body>
</html>
