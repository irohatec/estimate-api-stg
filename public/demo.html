<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>不動産査定デモ</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <main class="container">
    <h1 class="title">不動産査定デモ</h1>
    <p class="breadcrumb">Step0：利用者区分 → Step1：所在地/最寄り駅 → Step2：物件情報 → メール登録 → 査定送信</p>

    <!-- 送信時のみ出す：要約エラー -->
    <section id="errorSummary" class="error-summary hidden" aria-live="polite">
      <div class="error-summary__head">
        <span class="error-summary__icon" aria-hidden="true">⚠</span>
        入力に不備があります。以下を確認してください。
      </div>
      <ol id="errorList" class="error-summary__list"></ol>
    </section>

    <form id="estimateForm" novalidate>
      <!-- Step0 -->
      <section class="card">
        <div class="card__head">STEP 0. 利用者区分</div>
        <div class="grid">
          <div class="field">
            <label class="label">お申込み者さまの区分</label>
            <div class="radio-row" role="radiogroup" aria-label="利用者区分">
              <label class="radio">
                <input type="radio" name="userType" id="userType-individual" value="individual" checked>
                個人
              </label>
              <label class="radio">
                <input type="radio" name="userType" id="userType-corporate" value="corporate">
                法人
              </label>
            </div>
          </div>

          <div class="field" data-conditional="corporate">
            <label for="company" class="label required">会社名（法人の方）</label>
            <input id="company" name="company" class="input" type="text"
                   placeholder="いろはTEC"
                   data-label="会社名"
                   data-required-if="userType:corporate">
            <p id="err-company" class="error-text"></p>
          </div>

          <div class="field" data-conditional="corporate">
            <label for="contact" class="label required">連絡先（法人の方）</label>
            <input id="contact" name="contact" class="input" type="text"
                   placeholder="090-1234-5678 / support@example.com"
                   inputmode="email"
                   autocomplete="email"
                   data-label="連絡先"
                   data-required-if="userType:corporate"
                   data-validate="emailOrPhone">
            <p id="err-contact" class="error-text"></p>
          </div>
        </div>

        <div class="note">
          <ul>
            <li>法人を選んだ場合、会社名と連絡先は必須です。</li>
            <li>ご入力内容は査定および結果連絡のみに利用します。</li>
          </ul>
        </div>
      </section>

      <!-- Step1 -->
      <section class="card">
        <div class="card__head">STEP 1. 所在地と最寄り駅</div>
        <div class="grid">
          <div class="field">
            <label for="pref" class="label required">都道府県</label>
            <select id="pref" name="pref" class="select"
                    data-label="都道府県" required>
              <option value="">選択してください</option>
              <option value="広島県">広島県</option>
            </select>
            <p id="err-pref" class="error-text"></p>
          </div>

          <div class="field">
            <label for="city" class="label required">市区町村</label>
            <input id="city" name="city" class="input" type="text"
                   placeholder="広島市中区"
                   data-label="市区町村" required>
            <p id="err-city" class="error-text"></p>
          </div>

          <div class="field">
            <label for="town" class="label required">町名</label>
            <input id="town" name="town" class="input" type="text"
                   placeholder="宇品神田"
                   data-label="町名" required>
            <p id="err-town" class="error-text"></p>
          </div>

          <div class="field">
            <label for="chome" class="label">丁目</label>
            <select id="chome" name="chome" class="select" data-label="丁目">
              <option value="">未選択</option>
              <option>1丁目</option><option>2丁目</option><option>3丁目</option><option>4丁目</option>
              <option>5丁目</option><option>6丁目</option><option>7丁目</option><option>8丁目</option>
            </select>
            <p id="err-chome" class="error-text"></p>
          </div>

          <div class="field">
            <label for="banchi" class="label">番地</label>
            <input id="banchi" name="banchi" class="input" type="text"
                   placeholder="例：1-2-3"
                   data-label="番地">
            <p id="err-banchi" class="error-text"></p>
          </div>

          <div class="field">
            <label for="line" class="label required">路線</label>
            <select id="line" name="line" class="select"
                    data-label="路線" required>
              <option value="">選択してください</option>
              <option value="広島電鉄 本線">広島電鉄 本線</option>
              <option value="広島電鉄 宮島線">広島電鉄 宮島線</option>
              <option value="その他">その他</option>
            </select>
            <p id="err-line" class="error-text"></p>
          </div>

          <div class="field">
            <label for="station" class="label required">最寄り駅</label>
            <select id="station" name="station" class="select"
                    data-label="最寄り駅" required disabled>
              <option value="">先に路線を選択してください</option>
            </select>
            <p id="err-station" class="error-text"></p>
          </div>

          <div class="field">
            <label for="minutes" class="label required">駅から徒歩</label>
            <div class="inline">
              <select id="minutes" name="minutes" class="select narrow"
                      data-label="徒歩分" required data-validate="minutes">
                <option value="">選択</option>
              </select>
              <span>分</span>
            </div>
            <p id="err-minutes" class="error-text"></p>
          </div>
        </div>

        <div class="note">
          <ul>
            <li>市区町村は必ずご入力ください。</li>
            <li>電停/駅の指定は「路線 → 最寄り駅」の順で必須です。</li>
          </ul>
        </div>
      </section>

      <!-- Step2 -->
      <section class="card">
        <div class="card__head">STEP 2. 物件情報</div>
        <div class="grid">
          <div class="field">
            <label for="ptype" class="label required">物件種別</label>
            <select id="ptype" name="ptype" class="select" data-label="物件種別" required>
              <option value="">選択してください</option>
              <option>戸建</option>
              <option>マンション</option>
              <option>土地</option>
            </select>
            <p id="err-ptype" class="error-text"></p>
          </div>

          <div class="field">
            <label class="label required" for="area">面積</label>
            <div class="inline">
              <input id="area" name="area" class="input narrow" type="number" min="0" step="0.01"
                     placeholder="100" data-label="面積" required data-validate="positiveNumber">
              <select id="areaUnit" name="areaUnit" class="select narrow">
                <option value="sqm">㎡</option>
                <option value="tsubo">坪</option>
              </select>
            </div>
            <p id="err-area" class="error-text"></p>
          </div>

          <div class="field">
            <label for="builtYear" class="label required">築年（西暦）</label>
            <select id="builtYear" name="builtYear" class="select" data-label="築年" required>
              <option value="">選択してください</option>
            </select>
            <p id="err-builtYear" class="error-text"></p>
            <p class="help">
              耐震基準の目安：<strong>1981年（新耐震）</strong>で大幅強化、<strong>2000年基準</strong>で木造の接合や耐力壁のバランス等を追加強化。
            </p>
          </div>

          <div class="field">
            <label for="structure" class="label">構造</label>
            <select id="structure" name="structure" class="select" data-label="構造">
              <option value="">選択してください</option>
              <option>木造</option><option>鉄骨造</option><option>鉄筋コンクリート造</option>
              <option>鉄骨鉄筋コンクリート造</option>
            </select>
            <p id="err-structure" class="error-text"></p>
          </div>

          <div class="field">
            <label for="floors" class="label">建物階数（地上）</label>
            <input id="floors" name="floors" class="input" type="number" min="1" step="1"
                   placeholder="例：10" data-label="建物階数">
            <p id="err-floors" class="error-text"></p>
          </div>
        </div>
      </section>

      <!-- メール登録 / 送信 -->
      <section class="card">
        <div class="card__head">査定結果をメールで受け取る</div>
        <div class="grid">
          <div class="field">
            <label for="email" class="label required">メールアドレス</label>
            <input id="email" name="email" class="input" type="email"
                   placeholder="example@example.com"
                   inputmode="email" autocomplete="email"
                   data-label="メールアドレス" required>
            <p id="err-email" class="error-text"></p>
          </div>
        </div>

        <div class="actions">
          <button id="submitBtn" type="submit" class="btn" disabled>査定する</button>
          <span id="submitHint" class="muted">未入力の項目があります</span>
        </div>

        <div id="resultBox" class="result muted">査定結果はここに表示されます。</div>
      </section>
    </form>
  </main>

  <script>
    // -------------------------------
    // 初期データ
    // -------------------------------
    const lineStations = {
      "広島電鉄 本線": ["紙屋町東", "紙屋町西", "八丁堀", "立町", "銀山町", "稲荷町", "的場町"],
      "広島電鉄 宮島線": ["西広島", "草津", "井口", "修大協創中高前", "商工センター入口", "草津南", "古江"]
    };

    // 1〜60分のプルダウン
    const minutesSelect = document.getElementById("minutes");
    for (let i = 1; i <= 60; i++) {
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = String(i);
      minutesSelect.appendChild(opt);
    }

    // 築年（西暦）1970〜現年＋「1969年以前」
    const builtYearSelect = document.getElementById("builtYear");
    const now = new Date().getFullYear();
    const older = document.createElement("option");
    older.value = "1969以前";
    older.textContent = "1969年以前";
    builtYearSelect.appendChild(older);
    for (let y = now; y >= 1970; y--) {
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = `${y}年`;
      builtYearSelect.appendChild(opt);
    }

    // 路線→駅 連動
    const lineSel = document.getElementById("line");
    const stationSel = document.getElementById("station");
    lineSel.addEventListener("change", () => {
      stationSel.innerHTML = "";
      if (!lineSel.value || !lineStations[lineSel.value]) {
        stationSel.disabled = true;
        stationSel.appendChild(new Option("先に路線を選択してください", ""));
      } else {
        stationSel.disabled = false;
        stationSel.appendChild(new Option("選択してください", ""));
        lineStations[lineSel.value].forEach(s => stationSel.appendChild(new Option(s, s)));
      }
      markDirty(lineSel);
      validateField(stationSel); // 駅の再評価
      updateSubmitState();
    });

    // 法人→会社名/連絡先 必須化
    const userTypeRadios = document.querySelectorAll('input[name="userType"]');
    function applyCorporateRequired() {
      const isCorp = document.querySelector('input[name="userType"]:checked').value === "corporate";
      document.querySelectorAll('[data-conditional]').forEach(el => {
        el.style.display = isCorp ? "" : "none";
      });
      // 再評価
      ["company", "contact"].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          markDirty(el); // 触れた扱いにしても良いが、ここは非表示→表示の自然さ重視で維持
          validateField(el);
        }
      });
      updateSubmitState();
    }
    userTypeRadios.forEach(r => r.addEventListener("change", () => {
      markDirty(r);
      applyCorporateRequired();
    }));
    applyCorporateRequired();

    // -------------------------------
    // バリデーション基盤
    // -------------------------------
    const form = document.getElementById("estimateForm");
    const errorSummary = document.getElementById("errorSummary");
    const errorList = document.getElementById("errorList");
    const submitBtn = document.getElementById("submitBtn");
    const submitHint = document.getElementById("submitHint");
    let submittedOnce = false;

    function markDirty(el) {
      el.dataset.dirty = "1";
    }

    // 各フィールドに監視を設定
    const allInputs = form.querySelectorAll("input, select, textarea");
    allInputs.forEach(el => {
      el.addEventListener("input", () => {
        markDirty(el);
        validateField(el);
        updateSubmitState();
      });
      el.addEventListener("change", () => {
        markDirty(el);
        validateField(el);
        updateSubmitState();
      });
      el.addEventListener("blur", () => {
        markDirty(el);
        validateField(el);
        updateSubmitState();
      });
    });

    function isRequired(el) {
      // data-required-if="userType:corporate"
      const cond = el.dataset.requiredIf;
      if (!cond) return el.required;
      const [key, val] = cond.split(":");
      if (key === "userType") {
        const selected = document.querySelector('input[name="userType"]:checked')?.value;
        return selected === val;
      }
      return el.required;
    }

    function setFieldError(el, msg) {
      const id = el.id;
      const p = document.getElementById(`err-${id}`);
      if (p) p.textContent = msg || "";
      el.classList.toggle("invalid", !!msg);
      el.setAttribute("aria-invalid", !!msg);
    }

    function validateField(el) {
      const label = el.dataset.label || el.name || "項目";
      // 初期状態（未タッチ）は非表示
      const shouldShowInline = el.dataset.dirty === "1" || submittedOnce;

      // 条件必須の判定
      const need = isRequired(el);

      let err = "";
      if (need && !el.value) {
        err = `${label}を入力・選択してください`;
      }

      // 追加ルール
      if (!err && el.dataset.validate === "minutes" && el.value) {
        const v = Number(el.value);
        if (!(v >= 1 && v <= 60)) err = "徒歩分は1〜60で選択してください";
      }

      if (!err && el.dataset.validate === "positiveNumber" && el.value) {
        const n = Number(el.value);
        if (!(n > 0)) err = `${label}は0より大きい数で入力してください`;
      }

      if (!err && el.dataset.validate === "emailOrPhone" && el.value) {
        const v = el.value.trim();
        const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
        const phoneOk = /^[0-9+\-\s()]{8,}$/.test(v);
        if (!(emailOk || phoneOk)) err = "メールアドレスまたは電話番号の形式で入力してください";
      }

      // 駅 必須：路線が選ばれている時のみ厳格に
      if (!err && el.id === "station") {
        if (lineSel.value && !el.value) err = "最寄り駅を選択してください";
      }

      // 表示制御
      if (shouldShowInline) setFieldError(el, err); else setFieldError(el, "");

      return err;
    }

    function collectErrors() {
      const errors = [];
      allInputs.forEach(el => {
        const msg = validateField(el);
        if (msg) {
          errors.push({ id: el.id, label: el.dataset.label || el.name, msg });
        }
      });
      // 企業必須の視覚切替（非表示時のエラーは除外）
      const isCorp = document.querySelector('input[name="userType"]:checked').value === "corporate";
      if (!isCorp) {
        // 会社名/連絡先のエラーは除く
        return errors.filter(e => !["company", "contact"].includes(e.id));
      }
      return errors;
    }

    function updateSubmitState() {
      const errs = collectErrors();
      submitBtn.disabled = errs.length > 0;
      submitHint.textContent = errs.length > 0 ? "未入力の項目があります" : "送信できます";
      submitHint.classList.toggle("ok", errs.length === 0);

      // 要約は送信後のみ出す（常時は出さない）
      if (!submittedOnce) {
        errorSummary.classList.add("hidden");
      }
    }

    function renderErrorSummary(errs) {
      errorList.innerHTML = "";
      errs.forEach((e, i) => {
        const li = document.createElement("li");
        const a = document.createElement("a");
        a.href = `#${e.id}`;
        a.textContent = `${i + 1}. ${e.msg}`;
        a.addEventListener("click", (ev) => {
          ev.preventDefault();
          const target = document.getElementById(e.id);
          if (target) smoothFocus(target);
        });
        li.appendChild(a);
        errorList.appendChild(li);
      });
      errorSummary.classList.toggle("hidden", errs.length === 0);
    }

    function smoothFocus(el) {
      const y = el.getBoundingClientRect().top + window.scrollY - 90;
      window.scrollTo({ top: y, behavior: "smooth" });
      setTimeout(() => el.focus({ preventScroll: true }), 320);
    }

    // 初期化
    updateSubmitState();

    // 送信処理
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      submittedOnce = true;

      const errs = collectErrors();
      renderErrorSummary(errs);

      if (errs.length) {
        // 最初のエラーへスクロール
        const first = document.getElementById(errs[0].id);
        if (first) smoothFocus(first);
        return;
      }

      // フロント側で整形（必要最低限）
      const payload = {
        userType: document.querySelector('input[name="userType"]:checked').value,
        company: document.getElementById("company").value || null,
        contact: document.getElementById("contact").value || null,

        address: {
          pref: document.getElementById("pref").value,
          city: document.getElementById("city").value,
          town: document.getElementById("town").value,
          chome: document.getElementById("chome").value || null,
          banchi: document.getElementById("banchi").value || null,
        },
        line: document.getElementById("line").value,
        station: document.getElementById("station").value,
        walk_minutes: Number(document.getElementById("minutes").value),

        property: {
          type: document.getElementById("ptype").value,
          area: Number(document.getElementById("area").value),
          area_unit: document.getElementById("areaUnit").value,
          built_year: document.getElementById("builtYear").value,
          structure: document.getElementById("structure").value || null,
          floors: document.getElementById("floors").value ? Number(document.getElementById("floors").value) : null,
        },
        email: document.getElementById("email").value
      };

      const resultBox = document.getElementById("resultBox");
      resultBox.className = "result muted";
      resultBox.textContent = "査定計算中…";

      try {
        // /estimate は次チャットで実装予定
        const res = await fetch("/estimate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error("HTTP " + res.status);
        const json = await res.json();

        resultBox.className = "result success";
        resultBox.textContent = `概算価格：${(json.price ?? 0).toLocaleString()} 円（参考）`;
      } catch (err) {
        resultBox.className = "result danger";
        resultBox.textContent = "サーバーとの通信に失敗しました。後ほどお試しください。";
      }
    });
  </script>
</body>
</html>
