<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>不動産 簡易査定（UI検証用）</title>
  <!-- 絶対パスのまま -->
  <link rel="stylesheet" href="/style.css?v=1">
</head>
<body>
  <div class="wrap">
    <header class="header">
      <h1>不動産 簡易査定</h1>
      <p class="subtitle">見やすいUIで入力→査定金額を自動計算（UI検証用）</p>
    </header>

    <main class="grid">
      <!-- 左：フォーム -->
      <section class="card">
        <h2 class="card-title">査定フォーム</h2>

        <!-- 物件基本 -->
        <div class="field-row">
          <div class="field">
            <label for="propertyType">物件種別 <span class="req">※必須</span></label>
            <select id="propertyType">
              <option value="land">土地</option>
              <option value="house">戸建</option>
              <option value="apartment">マンション</option>
            </select>
          </div>

          <div class="field">
            <label for="area">専有面積（㎡） <span class="req">※必須</span></label>
            <input id="area" type="number" min="0" step="0.01" placeholder="例：100.56">
          </div>

          <div class="field" id="yearBuiltField">
            <label for="yearBuilt">築年（西暦） <span class="req" id="yearBuiltReq">※必須</span></label>
            <input id="yearBuilt" type="number" inputmode="numeric" placeholder="例：2005">
            <div class="help" id="yearHelp">土地は不要です（建物のみ必須）</div>
          </div>
        </div>

        <!-- 所在地（住所は必須／番地は任意だが「任意」表記なし） -->
        <div class="fieldset">
          <div class="legend">所在地 <span class="req">※必須</span></div>

          <div class="field-row">
            <div class="field">
              <label for="pref">都道府県</label>
              <select id="pref"></select>
            </div>

            <div class="field">
              <label for="city">市区町村</label>
              <select id="city"></select>
            </div>

            <div class="field">
              <label for="town">町・丁目</label>
              <select id="town"></select>
            </div>
          </div>

          <div class="field">
            <label for="blockLot">番地</label>
            <input id="blockLot" type="text" placeholder="例：1-2-3">
            <div class="help">未入力でも査定できます</div>
          </div>
        </div>

        <!-- 最寄り駅（任意：コード送信） -->
        <div class="fieldset">
          <div class="legend">最寄り駅（任意）</div>

          <div class="field-row">
            <div class="field">
              <label for="line">路線</label>
              <select id="line">
                <option value="">（選択なし）</option>
              </select>
            </div>

            <div class="field">
              <label for="station">駅</label>
              <select id="station" disabled>
                <option value="">（選択なし）</option>
              </select>
            </div>
          </div>
        </div>

        <!-- 送信操作 -->
        <div class="actions">
          <button id="sendBtn" class="btn-primary">Send /estimate</button>
          <button id="resetBtn" class="btn-outline" type="button">リセット</button>
        </div>
      </section>

      <!-- 右：結果 -->
      <section class="card">
        <h2 class="card-title">査定結果</h2>
        <div id="resultBox" class="result-box muted">まだ査定は行われていません。</div>

        <details class="json-details">
          <summary>レスポンス詳細（JSON表示）</summary>
          <pre id="respJson" class="json-view"></pre>
        </details>
      </section>
    </main>

    <!-- 最下部：メール送信（v0はサーバ側でno-op） -->
    <section class="card bottom-card">
      <h2 class="card-title">結果のメール送信（任意）</h2>
      <div class="field-row">
        <div class="field">
          <label for="email">宛先メールアドレス</label>
          <input id="email" type="email" placeholder="例：example@example.com">
        </div>
        <div class="field">
          <label for="sendMail">
            <input id="sendMail" type="checkbox"> 結果をメール通知する（v0は保存のみ／送信スキップ）
          </label>
        </div>
      </div>
    </section>

    <footer class="footer">
      <a class="health" href="/health" target="_blank" rel="noopener">/health を新規タブで開く</a>
    </footer>
  </div>

  <script>
    // =========================
    // 静的データ（MVP：広島市のみ）
    // =========================
    const ADDRESS_DATA = {
      "prefectures": [
        {
          "name": "広島県",
          "cities": [
            {
              "name": "広島市南区",
              "towns": ["宇品東一丁目","宇品西一丁目","段原南一丁目","比治山本町","皆実町一丁目"]
            },
            {
              "name": "広島市中区",
              "towns": ["大手町一丁目","袋町","紙屋町一丁目","上八丁堀","基町"]
            },
            {
              "name": "広島市東区",
              "towns": ["光町一丁目","若草町","牛田本町一丁目","曙一丁目"]
            },
            {
              "name": "広島市西区",
              "towns": ["横川町一丁目","草津新町一丁目","庚午北一丁目"]
            },
            {
              "name": "広島市安佐南区",
              "towns": ["大町東一丁目","中筋一丁目","西原一丁目"]
            },
            {
              "name": "広島市安佐北区",
              "towns": ["可部一丁目","口田南一丁目"]
            },
            {
              "name": "広島市佐伯区",
              "towns": ["五日市一丁目","楽々園一丁目"]
            },
            {
              "name": "広島市安芸区",
              "towns": ["船越南一丁目","矢野東一丁目"]
            }
          ]
        }
      ]
    };

    // 路線→駅（コードは自前スキーマ／例）
    const STATION_DATA = {
      "lines": [
        {
          "code": "HRJ-TRAM-MAIN",
          "name": "広島電鉄 本線",
          "stations": [
            {"code":"HRJ-AL-00001","name":"広島駅"},
            {"code":"HRJ-AL-00015","name":"紙屋町東"},
            {"code":"HRJ-AL-00016","name":"紙屋町西"},
            {"code":"HRJ-AL-00020","name":"本通"}
          ]
        },
        {
          "code": "HRJ-TRAM-UJINA",
          "name": "広島電鉄 宇品線",
          "stations": [
            {"code":"HRJ-UJ-00010","name":"県病院前"},
            {"code":"HRJ-UJ-00014","name":"皆実町六丁目"},
            {"code":"HRJ-UJ-00020","name":"宇品二丁目"}
          ]
        }
      ]
    };

    // =========================
    // 初期化
    // =========================
    const $ = (s) => document.querySelector(s);
    const sendBtn = $('#sendBtn');
    const resetBtn = $('#resetBtn');
    const resultBox = $('#resultBox');
    const respJson = $('#respJson');

    const propertyType = $('#propertyType');
    const area = $('#area');
    const yearBuilt = $('#yearBuilt');
    const yearBuiltField = $('#yearBuiltField');
    const yearBuiltReq = $('#yearBuiltReq');

    const prefSel = $('#pref');
    const citySel = $('#city');
    const townSel = $('#town');
    const blockLot = $('#blockLot');

    const lineSel = $('#line');
    const stationSel = $('#station');

    const email = $('#email');
    const sendMail = $('#sendMail');

    function populateAddress() {
      // 都道府県
      prefSel.innerHTML = '';
      ADDRESS_DATA.prefectures.forEach((p, idx) => {
        const opt = document.createElement('option');
        opt.value = p.name;
        opt.textContent = p.name;
        prefSel.appendChild(opt);
      });

      // 市区町村（広島市南区をデフォルト）
      const pref = ADDRESS_DATA.prefectures[0];
      citySel.innerHTML = '';
      pref.cities.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.name;
        opt.textContent = c.name;
        citySel.appendChild(opt);
      });
      // デフォルト：広島市南区
      citySel.value = '広島市南区';

      // 町・丁目
      populateTowns();
    }

    function populateTowns() {
      const pref = ADDRESS_DATA.prefectures.find(p => p.name === prefSel.value);
      const city = pref.cities.find(c => c.name === citySel.value);
      townSel.innerHTML = '';
      city.towns.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        townSel.appendChild(opt);
      });
    }

    function populateStations() {
      // 路線
      lineSel.innerHTML = '<option value="">（選択なし）</option>';
      STATION_DATA.lines.forEach(l => {
        const opt = document.createElement('option');
        opt.value = l.code;
        opt.textContent = l.name;
        lineSel.appendChild(opt);
      });

      stationSel.innerHTML = '<option value="">（選択なし）</option>';
      stationSel.disabled = true;
    }

    function updateStations() {
      const line = STATION_DATA.lines.find(l => l.code === lineSel.value);
      stationSel.innerHTML = '<option value="">（選択なし）</option>';
      if (!line) {
        stationSel.disabled = true;
        return;
      }
      line.stations.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.code; // コードを送る
        opt.textContent = s.name;
        stationSel.appendChild(opt);
      });
      stationSel.disabled = false;
    }

    function toggleYearBuiltRequirement() {
      const type = propertyType.value;
      if (type === 'land') {
        yearBuilt.required = false;
        yearBuilt.value = '';
        yearBuilt.disabled = true;
        yearBuiltReq.style.visibility = 'hidden';
        yearBuiltField.classList.add('disabled');
      } else {
        yearBuilt.disabled = false;
        yearBuilt.required = true;
        yearBuiltReq.style.visibility = 'visible';
        yearBuiltField.classList.remove('disabled');
      }
    }

    prefSel.addEventListener('change', () => {
      // 今回は1都道府県のみだが将来拡張用
      const prevCity = citySel.value;
      populateAddress();
      // 直前の市が同じなら維持、なければデフォルト
      if ([...citySel.options].some(o => o.value === prevCity)) {
        citySel.value = prevCity;
        populateTowns();
      }
    });

    citySel.addEventListener('change', populateTowns);
    lineSel.addEventListener('change', updateStations);
    propertyType.addEventListener('change', toggleYearBuiltRequirement);

    resetBtn.addEventListener('click', () => {
      propertyType.value = 'land';
      area.value = '';
      yearBuilt.value = '';
      toggleYearBuiltRequirement();

      populateAddress();
      blockLot.value = '';

      lineSel.value = '';
      updateStations();

      email.value = '';
      sendMail.checked = false;

      resultBox.classList.add('muted');
      resultBox.textContent = 'まだ査定は行われていません。';
      respJson.textContent = '';
    });

    async function handleSend() {
      // フロント側バリデーション（最小）
      const errs = [];
      if (!propertyType.value) errs.push('物件種別を選択してください。');

      const areaVal = parseFloat(area.value);
      if (Number.isNaN(areaVal) || areaVal <= 0) errs.push('面積は0より大きい数値で入力してください。');

      if (propertyType.value !== 'land') {
        const y = Number(yearBuilt.value);
        const thisYear = new Date().getFullYear();
        if (!y || y < 1900 || y > thisYear) errs.push(`築年は1900〜${thisYear}の範囲で入力してください。`);
      }

      if (!prefSel.value || !citySel.value || !townSel.value) {
        errs.push('住所（都道府県／市区町村／町・丁目）を選択してください。');
      }

      if (errs.length > 0) {
        resultBox.classList.remove('muted');
        resultBox.classList.add('error');
        resultBox.textContent = errs[0];
        return;
      }

      // ペイロード（互換重視：不要キーは送らない）
      const payload = {
        property_type: propertyType.value,            // land / house / apartment
        area_sqm: areaVal,
        address: {
          pref: prefSel.value,
          city: citySel.value,
          town: townSel.value,
          block_lot: (blockLot.value || '').trim()
        }
      };

      if (propertyType.value !== 'land') {
        payload.year_built = Number(yearBuilt.value);
      }

      // 最寄り駅（任意）
      if (stationSel.value) {
        payload.station_code = stationSel.value;
      }

      // v0メール（任意）— サーバ側は no-op を想定
      if (sendMail.checked && email.value) {
        payload.notify_email = email.value.trim();
        payload.options = { send_mail: true };
      }

      // 互換性のため、lat/lng をUIから廃止したが hidden送信はせず未送信（サーバ側でoptional想定）

      // 送信
      setBusy(true, '計算中です…');
      try {
        const res = await fetch('/estimate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok || data.ok === false) {
          throw new Error((data && data.error) || `HTTP ${res.status}`);
        }

        // 表示（上は要点、下はJSON）
        renderResult(data);
        respJson.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        resultBox.classList.remove('muted');
        resultBox.classList.add('error');
        resultBox.textContent = `エラー：${err.message || err}`;
        respJson.textContent = '';
      } finally {
        setBusy(false);
      }
    }

    function renderResult(data) {
      const r = data && data.result;
      if (!r) {
        resultBox.classList.remove('muted');
        resultBox.textContent = '結果データが取得できませんでした。';
        return;
      }
      const price = numfmt(r.price);
      const low = numfmt(r.range_low);
      const high = numfmt(r.range_high);

      resultBox.classList.remove('muted', 'error');
      resultBox.innerHTML = `
        <div class="price">推定価格：<strong>${price}</strong></div>
        <div class="range">レンジ：${low} 〜 ${high}</div>
        <div class="basis">
          <span class="chip">基準単価(参考)：${r.basis?.p60_baseline_ppsqm ? numfmt(r.basis.p60_baseline_ppsqm) + ' 円/㎡' : '—'}</span>
          <span class="chip">年式補正：${fmtAdj(r.adjustments?.age_rate)}</span>
          <span class="chip">時点補正：${fmtAdj(r.adjustments?.time_factor, true)}</span>
        </div>
      `;
    }

    function numfmt(n) {
      if (typeof n !== 'number') return '—';
      return n.toLocaleString('ja-JP', { maximumFractionDigits: 0 }) + ' 円';
    }
    function fmtAdj(v, multiplicative=false) {
      if (v == null) return '—';
      if (multiplicative) return `${v}`;
      const pct = (v * 100).toFixed(1);
      return `${pct}%`;
    }

    function setBusy(busy, msg) {
      if (busy) {
        sendBtn.disabled = true;
        sendBtn.textContent = msg || '送信中…';
      } else {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send /estimate';
      }
    }

    // イベント
    sendBtn.addEventListener('click', (e) => {
      e.preventDefault();
      handleSend();
    });

    // 初期起動
    populateAddress();
    populateStations();
    toggleYearBuiltRequirement();
  </script>
</body>
</html>
