<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>不動産査定デモ（Step0→Step2＋メール登録）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- ルート固定 -->
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <div class="wrap">

    <!-- ===================== Header ===================== -->
    <header class="mb-16">
      <h1>不動産査定デモ</h1>
      <p class="text-sub">Step0: 利用者区分 → Step1: 所在地/沿線 → Step2: 物件情報 → メール登録</p>
    </header>

    <!-- ===================== Step0: 利用者区分（個人/法人） ===================== -->
    <section class="card mb-24" id="step0">
      <h2>STEP 0. 利用者区分</h2>

      <div class="grid">
        <div class="field">
          <label>あなたは個人/法人のどちらですか？</label>
          <div class="field-row">
            <label><input type="radio" name="userType" value="individual" checked /> 個人</label>
            <label class="ml-16"><input type="radio" name="userType" value="corporate" /> 法人</label>
          </div>
        </div>

        <!-- 法人のみ表示 -->
        <div class="field hidden" id="corpNameField">
          <label for="corpName">会社名（法人のみ必須）</label>
          <input id="corpName" type="text" placeholder="例：○○不動産株式会社" />
        </div>

        <div class="field hidden" id="corpContactField">
          <label for="corpContact">連絡先（法人のみ必須）</label>
          <input id="corpContact" type="text" placeholder="例：090-1234-5678 / support@example.com" />
          <small class="help">電話番号またはメールアドレスのどちらか</small>
        </div>
      </div>

      <div class="result-box info mt-12">
        <p><strong>※注意事項</strong></p>
        <ul>
          <li>本サービスは、AI査定のため、参考価格となります。</li>
          <li>法人のお客様のご利用も可能ですが、会社名と連絡先をご登録の上、ご利用ください。</li>
        </ul>
      </div>
    </section>

    <!-- ===================== Step1: 所在地 & 沿線 ===================== -->
    <section class="card mb-24" id="step1">
      <div class="flex-row">
        <h2>STEP 1. 所在地と最寄り駅</h2>
        <button id="btnCheckStep1" class="btn-outline">入力チェック</button>
      </div>

      <!-- 所在地 -->
      <div class="grid">
        <div class="field">
          <label for="wardSelect">市区町村（※必須）</label>
          <select id="wardSelect">
            <option value="">選択してください</option>
          </select>
          <small class="help" id="wardSrc">読込: /address/hiroshima/index.json</small>
        </div>

        <div class="field">
          <label for="townSelect">町名</label>
          <select id="townSelect" disabled>
            <option value="">先に市区町村を選択</option>
          </select>
        </div>

        <div class="field">
          <label for="chomeSelect">丁目</label>
          <select id="chomeSelect" disabled>
            <option value="">丁目なし</option>
          </select>
        </div>

        <div class="field">
          <label for="banchiInput">番地</label>
          <input id="banchiInput" type="text" placeholder="例: 1-2-3" />
          <small class="help">番地が空欄のときは <strong>最寄り駅の指定が必須</strong> です</small>
        </div>
      </div>

      <!-- 沿線 -->
      <div class="grid mt-12">
        <div class="field">
          <label for="lineSelect">路線</label>
          <select id="lineSelect">
            <option value="">選択してください</option>
          </select>
          <small class="help" id="lineSrc">読込: /rail/hiroshima/index.json</small>
        </div>

        <div class="field">
          <label for="stationSelect">駅</label>
          <select id="stationSelect" disabled>
            <option value="">先に路線を選択</option>
          </select>
        </div>
      </div>

      <!-- エラーまとめ（Step1） -->
      <div class="result-box error mt-16 hidden" id="step1Error">
        <p class="mb-4"><strong>入力に不備があります。以下をご確認ください。</strong></p>
        <ul id="step1ErrorList"></ul>
      </div>

      <div class="result-box info mt-12" id="step1Tips">
        <p class="mb-2"><strong>入力ルール</strong></p>
        <ul>
          <li>市区町村は必須です</li>
          <li>番地が空欄の場合は「最寄り駅の指定」が必須です</li>
        </ul>
      </div>
    </section>

    <!-- ===================== Step2: 物件情報（築年＝西暦セレクト対応） ===================== -->
    <section class="card" id="step2">
      <div class="flex-row">
        <h2>STEP 2. 物件情報</h2>
        <button id="btnCheckStep2" class="btn-outline">入力チェック</button>
      </div>

      <div class="grid">
        <div class="field">
          <label for="typeSelect">物件種別</label>
          <select id="typeSelect">
            <option value="">選択してください</option>
            <option value="戸建">戸建</option>
            <option value="マンション">マンション</option>
            <option value="土地">土地</option>
            <option value="一棟マンション">一棟マンション</option>
            <option value="一棟アパート">一棟アパート</option>
          </select>
        </div>

        <div class="field">
          <label for="areaInput">面積</label>
          <div class="field-row">
            <input id="areaInput" type="number" step="0.01" placeholder="例: 80" />
            <select id="areaUnit">
              <option value="sqm">㎡</option>
              <option value="tsubo">坪</option>
            </select>
          </div>
        </div>

        <!-- 築年（西暦）セレクト -->
        <div class="field">
          <label for="builtYear">築年（建築年・西暦）</label>
          <select id="builtYear">
            <!-- JS で 2025 → 1970 を自動生成、最後に 1969年以前 を追加 -->
          </select>
          <small class="help">
            ※査定では <strong>1981年基準</strong>（新耐震）と <strong>2000年基準</strong> を境に補正します。  
            「新新耐震基準」という用語は一般的ではなく、実務では<strong>2000年基準</strong>を指します。
          </small>
        </div>

        <div class="field">
          <label for="layoutSelect">間取り</label>
          <select id="layoutSelect">
            <option value="">選択してください</option>
            <option value="1R">1R</option>
            <option value="1K">1K</option>
            <option value="1LDK">1LDK</option>
            <option value="2LDK">2LDK</option>
            <option value="3LDK">3LDK</option>
            <option value="4LDK">4LDK</option>
            <option value="5LDK以上">5LDK以上</option>
          </select>
        </div>

        <div class="field">
          <label for="orientationSelect">採光面</label>
          <select id="orientationSelect">
            <option value="">選択してください</option>
            <option value="南">南</option>
            <option value="東">東</option>
            <option value="西">西</option>
            <option value="北">北</option>
            <option value="南東">南東</option>
            <option value="南西">南西</option>
            <option value="北東">北東</option>
            <option value="北西">北西</option>
          </select>
        </div>
      </div>

      <div class="grid mt-12">
        <div class="field">
          <label for="structureSelect">構造</label>
          <select id="structureSelect">
            <option value="">選択してください</option>
            <option value="木造">木造</option>
            <option value="軽量鉄骨">軽量鉄骨</option>
            <option value="重量鉄骨">重量鉄骨</option>
            <option value="RC">RC（鉄筋コンクリート）</option>
            <option value="SRC">SRC（鉄骨鉄筋コンクリート）</option>
            <option value="PC">PC（プレキャスト）</option>
          </select>
        </div>

        <!-- ご要望により「規模（総戸数）」「建物階数（地下）」は削除 -->
        <div class="field">
          <label for="bldgFloors">建物階数（地上）</label>
          <input id="bldgFloors" type="number" min="0" placeholder="例: 10" />
        </div>

        <div class="field">
          <label for="unitFloor">所在階</label>
          <input id="unitFloor" type="number" min="0" placeholder="例: 7" />
          <small class="help">マンション/共同住宅のみ入力してください</small>
        </div>
      </div>

      <!-- エラーまとめ（Step2） -->
      <div class="result-box error mt-16 hidden" id="step2Error">
        <p class="mb-4"><strong>入力に不備があります。以下をご確認ください。</strong></p>
        <ul id="step2ErrorList"></ul>
      </div>
    </section>

    <!-- ===================== メール登録：査定結果を送る ===================== -->
    <section class="card mt-24" id="emailSection">
      <h2>査定結果をメールで受け取る</h2>
      <div class="grid">
        <div class="field">
          <label for="emailForResult">メールアドレス</label>
          <input id="emailForResult" type="email" placeholder="例：you@example.com" />
          <small class="help">査定結果をこのメールアドレス宛に送信します（後で変更可）</small>
        </div>
      </div>
      <div class="grid mt-8">
        <div class="field">
          <button class="btn-primary" id="btnRegisterEmail" type="button">査定結果を送る（メール登録）</button>
          <small class="help">※現在は仮実装です。/estimate とメール送信は次の工程で有効化します。</small>
        </div>
      </div>
      <div class="result-box placeholder mt-8" id="emailMsg" style="display:none;"></div>
    </section>

  </div>

  <!-- ===================== Script ===================== -->
  <script>
    // --------- 要素参照 ---------
    const $ = (s)=>document.querySelector(s);
    const elWard = $('#wardSelect');
    const elTown = $('#townSelect');
    const elChome = $('#chomeSelect');
    const elLine = $('#lineSelect');
    const elStation = $('#stationSelect');
    const elBuiltYear = $('#builtYear');

    // Step0
    const userTypeRadios = document.querySelectorAll('input[name="userType"]');
    const corpNameField = $('#corpNameField');
    const corpContactField = $('#corpContactField');

    // --------- ユーティリティ ---------
    function toggleCorpFields(){
      const v = [...userTypeRadios].find(r=>r.checked)?.value;
      const corp = (v === 'corporate');
      corpNameField.classList.toggle('hidden', !corp);
      corpContactField.classList.toggle('hidden', !corp);
    }
    userTypeRadios.forEach(r=>r.addEventListener('change', toggleCorpFields));
    toggleCorpFields();

    // 西暦セレクト生成：2025→1970、最後に「1969年以前」
    (function buildYearOptions(){
      const max = 2025;
      const min = 1970;
      elBuiltYear.innerHTML = '<option value="">選択してください</option>';
      for(let y=max; y>=min; y--){
        const opt = document.createElement('option');
        opt.value = String(y);
        opt.textContent = `${y}年`;
        elBuiltYear.appendChild(opt);
      }
      const older = document.createElement('option');
      older.value = '1969以前';
      older.textContent = '1969年以前';
      elBuiltYear.appendChild(older);
    })();

    // --------- 所在地 ---------
    async function loadWards(){
      const res = await fetch('/address/hiroshima/index.json', {cache:'no-store'});
      if(!res.ok) throw new Error('/address/hiroshima/index.json → '+res.status);
      const data = await res.json();
      elWard.innerHTML = '<option value="">選択してください</option>';
      (data.wards||[]).forEach(w=>{
        const opt = document.createElement('option');
        opt.value = w.code;
        opt.textContent = w.name;
        opt.dataset.path = '/' + w.path; // /address/hiroshima/34103.json
        elWard.appendChild(opt);
      });
    }
    async function loadTownsByPath(path){
      elTown.disabled = true;
      elChome.disabled = true;
      elTown.innerHTML = '<option value="">読み込み中...</option>';
      elChome.innerHTML = '<option value="">丁目なし</option>';
      const res = await fetch(path, {cache:'no-store'});
      if(!res.ok) throw new Error(path+' → '+res.status);
      const wardData = await res.json();
      elTown.innerHTML = '<option value="">選択してください</option>';
      (wardData.towns||[]).forEach(t=>{
        const opt = document.createElement('option');
        opt.value = t.name;
        opt.textContent = t.name;
        opt.dataset.chome = JSON.stringify(t.chome||[]);
        elTown.appendChild(opt);
      });
      elTown.disabled = false;
      elChome.disabled = true;
    }
    function onTownChange(){
      const sel = elTown.selectedOptions[0];
      if(!sel) return;
      const chomes = JSON.parse(sel.dataset.chome||'[]');
      if(!chomes.length){
        elChome.disabled = true;
        elChome.innerHTML = '<option value="">丁目なし</option>';
      }else{
        elChome.disabled = false;
        elChome.innerHTML = '<option value="">選択してください</option>';
        chomes.forEach(c=>{
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c;
          elChome.appendChild(opt);
        });
      }
    }

    // --------- 路線 ---------
    async function loadLines(){
      const res = await fetch('/rail/hiroshima/index.json', {cache:'no-store'});
      if(!res.ok) throw new Error('/rail/hiroshima/index.json → '+res.status);
      const data = await res.json();
      elLine.innerHTML = '<option value="">選択してください</option>';
      (data.lines||[]).forEach(l=>{
        const opt = document.createElement('option');
        opt.value = l.code;
        opt.textContent = `${l.company} ${l.name_ja}`;
        opt.dataset.file = l.file; // hiroden-honsen.json
        elLine.appendChild(opt);
      });
    }
    async function loadStationsByFile(file){
      elStation.disabled = true;
      elStation.innerHTML = '<option value="">読み込み中...</option>';
      const url = '/rail/hiroshima/'+file;
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error(url+' → '+res.status);
      const data = await res.json();
      elStation.innerHTML = '<option value="">選択してください</option>';
      (data.stations||[]).forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s.code;
        opt.textContent = s.name_ja;
        elStation.appendChild(opt);
      });
      elStation.disabled = false;
    }

    // --------- Step1 バリデーション ---------
    function validateStep1(){
      const errors = [];
      const ward = elWard.value;
      const town = elTown.value;
      const chome = elChome.disabled ? '' : elChome.value;
      const banchi = $('#banchiInput').value.trim();
      const line = elLine.value;
      const station = elStation.value;

      if(!ward) errors.push('市区町村を選択してください。');
      if(!banchi && !station) errors.push('番地が未入力のため、最寄り駅の選択が必須です。');
      if(banchi && !/^[0-9０-９]+(-[0-9０-９]+)*$/.test(banchi)) {
        errors.push('番地は半角数字とハイフンで入力してください（例：1-2-3）。');
      }
      // 将来：住所×路線の整合チェックを入れる場合はここに追加

      const box = $('#step1Error');
      const list = $('#step1ErrorList');
      if(errors.length){
        list.innerHTML = errors.map(e=>`<li>${e}</li>`).join('');
        box.classList.remove('hidden');
      }else{
        box.classList.add('hidden');
      }
      return errors.length === 0;
    }

    // --------- Step2 バリデーション ---------
    function validateStep2(){
      const errors = [];
      const type = $('#typeSelect').value;
      const area = parseFloat($('#areaInput').value);
      const unit = $('#areaUnit').value;
      const byear = $('#builtYear').value;

      if(!type) errors.push('物件種別を選択してください。');
      if(Number.isNaN(area) || area <= 0) errors.push('面積を正しく入力してください。');
      if(!byear) errors.push('築年（建築年）を選択してください。');

      const box = $('#step2Error');
      const list = $('#step2ErrorList');
      if(errors.length){
        list.innerHTML = errors.map(e=>`<li>${e}</li>`).join('');
        box.classList.remove('hidden');
      }else{
        box.classList.add('hidden');
      }
      return errors.length === 0;
    }

    // --------- イベント ---------
    elWard.addEventListener('change', async ()=>{
      const p = elWard.selectedOptions[0]?.dataset.path;
      try { if(p) await loadTownsByPath(p); $('#step1Error').classList.add('hidden'); }
      catch(err){ showStep1LoadError('市区町村の読み込みに失敗しました: '+err.message); }
    });
    elTown.addEventListener('change', onTownChange);
    elLine.addEventListener('change', async ()=>{
      const f = elLine.selectedOptions[0]?.dataset.file;
      try { if(f) await loadStationsByFile(f); $('#step1Error').classList.add('hidden'); }
      catch(err){ showStep1LoadError('路線/駅の読み込みに失敗しました: '+err.message); }
    });
    function showStep1LoadError(msg){
      const box = $('#step1Error'); const list = $('#step1ErrorList');
      list.innerHTML = `<li>${msg}</li>`; box.classList.remove('hidden');
    }
    $('#btnCheckStep1').addEventListener('click', validateStep1);
    $('#btnCheckStep2').addEventListener('click', validateStep2);

    // メール登録（現時点は仮）
    $('#btnRegisterEmail').addEventListener('click', ()=>{
      const userType = [...document.querySelectorAll('input[name="userType"]')].find(r=>r.checked)?.value;
      const corpName = $('#corpName').value.trim();
      const corpContact = $('#corpContact').value.trim();
      if(userType==='corporate' && (!corpName || !corpContact)){
        return showEmailMsg('法人をご選択の場合は「会社名」と「連絡先」が必要です。', true);
      }
      const email = $('#emailForResult').value.trim();
      if(!email) return showEmailMsg('メールアドレスを入力してください。', true);
      // 今は登録確認のみ（査定API接続時に送信処理）
      showEmailMsg('メールアドレスを仮登録しました。査定API連携後に送信します。', false);
    });
    function showEmailMsg(msg, isError){
      const box = $('#emailMsg'); box.className = 'result-box ' + (isError?'error':'info');
      box.textContent = msg; box.style.display = 'block';
    }

    // 初期ロード
    (async()=>{
      try{
        await Promise.all([loadWards(), loadLines()]);
      }catch(err){
        const box = $('#step1Error'), list = $('#step1ErrorList');
        list.innerHTML = `<li>初期データの読み込みに失敗しました: ${err.message}</li>`;
        box.classList.remove('hidden');
        console.error(err);
      }
    })();
  </script>
</body>
</html>
