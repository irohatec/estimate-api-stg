<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Rail JSON 生成ツール（Station.geojson → index.json / 路線別JSON）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; line-height: 1.6; margin: 20px; }
    textarea { width: 100%; height: 220px; }
    input[type="number"] { width: 140px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .btn { padding: 8px 14px; border: 1px solid #333; border-radius: 8px; background: #fff; cursor: pointer; }
    .btn:disabled { opacity: .4; cursor: not-allowed; }
    .log { background: #111; color: #0f0; padding: 10px; border-radius: 8px; white-space: pre-wrap; max-height: 360px; overflow: auto; }
    .downloads a { margin-right: 10px; }
    small code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; }
    label { user-select: none; }
    .muted { opacity: .6 }
  </style>
</head>
<body>
  <h1>Rail JSON 生成ツール</h1>
  <p>
    国土数値情報の <b>N02-20_Station.geojson</b>（駅データ）を下に貼り付けて「生成」を押すと、<br>
    <b>rail/hiroshima/index.json</b> と <b>路線ごとの JSON</b> をダウンロードできます。外部送信はありません。
  </p>

  <h3>1) GeoJSON（Station）を貼り付け</h3>
  <textarea id="geojson" placeholder="ここに N02-20_Station.geojson の内容を丸ごと貼り付け"></textarea>

  <h3>2) 抽出条件</h3>
  <div class="row">
    <label><input type="radio" name="scope" value="pref" checked> 都道府県で絞る</label>
    <select id="prefSelect" title="都道府県">
      <option value="JP">全国（制限なし）</option>
      <option value="34" selected>広島県（34）</option>
      <!-- 必要になったら他県も足せます -->
      <option value="33">岡山県（33）</option>
      <option value="35">山口県（35）</option>
      <option value="38">愛媛県（38）</option>
      <option value="32">島根県（32）</option>
    </select>

    <span class="muted">／または</span>

    <label><input type="radio" name="scope" value="bbox"> BBOXで絞る</label>
    <div>minLon: <input type="number" id="minLon" step="0.0001" value="131.5" disabled></div>
    <div>minLat: <input type="number" id="minLat" step="0.0001" value="33.5" disabled></div>
    <div>maxLon: <input type="number" id="maxLon" step="0.0001" value="133.5" disabled></div>
    <div>maxLat: <input type="number" id="maxLat" step="0.0001" value="35.0" disabled></div>
  </div>
  <div class="row" style="margin-top:6px;">
    <div>
      会社名フィルタ（任意・部分一致）:
      <input type="text" id="companyFilter" placeholder="例: 広島電鉄 / JR西日本 / アストラムライン">
    </div>
  </div>

  <div class="row" style="margin-top:10px;">
    <button id="runBtn" class="btn">生成</button>
    <button id="clearBtn" class="btn" type="button">リセット</button>
  </div>

  <h3>ログ</h3>
  <div id="log" class="log" aria-live="polite"></div>

  <h3>ダウンロード</h3>
  <div id="downloads" class="downloads"></div>
  <p><small>保存先の目安：<code>rail/hiroshima/</code> 配下に置き、<code>index.json</code> は <code>/rail/hiroshima/index.json</code> で参照されるようにしてください。</small></p>

<script>
// ----- 都道府県 → BBOX プリセット（簡易版：広島＋近隣） -----
// 必要に応じて他県を追記できます。全国は BBOX 無制限扱い。
const PREF_BBOX = {
  "JP": null, // 全国（制限なし）
  "34": { name: "広島県", minLon: 131.5, minLat: 33.5, maxLon: 133.5, maxLat: 35.0 },
  "33": { name: "岡山県", minLon: 133.4, minLat: 34.3, maxLon: 134.4, maxLat: 35.2 },
  "35": { name: "山口県", minLon: 130.8, minLat: 33.7, maxLon: 132.1, maxLat: 34.7 },
  "38": { name: "愛媛県", minLon: 132.0, minLat: 32.8, maxLon: 133.8, maxLat: 34.1 },
  "32": { name: "島根県", minLon: 131.4, minLat: 34.0, maxLon: 133.3, maxLat: 35.5 }
};

// ---------- 小物 ----------
const log = (...a) => { const el = document.getElementById('log'); el.textContent += '[tool] ' + a.join(' ') + '\n'; el.scrollTop = el.scrollHeight; };
const warn = (...a) => { const el = document.getElementById('log'); el.textContent += '[WARN] ' + a.join(' ') + '\n'; el.scrollTop = el.scrollHeight; };
const err  = (...a) => { const el = document.getElementById('log'); el.textContent += '[ERROR] ' + a.join(' ') + '\n'; el.scrollTop = el.scrollHeight; };

function downloadJSON(obj, filename) {
  const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.textContent = filename; a.className = 'btn';
  document.getElementById('downloads').appendChild(a);
  document.getElementById('downloads').appendChild(document.createTextNode(' '));
}

function slugify(s) {
  return String(s || '').normalize('NFKC')
    .replace(/[（）\(\)\s]/g, '_')
    .replace(/[^\w\-ァ-ン一-龥]/g, '_')
    .replace(/_+/g, '_')
    .replace(/^_|_$/g, '')
    .toLowerCase();
}

// 座標を堅牢に取り出す: Point/MultiPoint対応 + lon/lat自動判定
function extractLonLat(geom) {
  if (!geom) return null;
  let coords = null;
  if (geom.type === 'Point') coords = geom.coordinates;
  else if (geom.type === 'MultiPoint' && Array.isArray(geom.coordinates) && geom.coordinates.length) coords = geom.coordinates[0];
  if (!Array.isArray(coords) || coords.length < 2) return null;

  let x = Number(coords[0]), y = Number(coords[1]);
  if (!Number.isFinite(x) || !Number.isFinite(y)) return null;

  // 自動スワップ: もし x が緯度(<=90) かつ y が経度(>90)っぽければ入替
  if (Math.abs(x) <= 90 && Math.abs(y) >= 90) {
    const t = x; x = y; y = t;
  }
  // あり得ない値は弾く
  if (Math.abs(x) > 180 || Math.abs(y) > 90) return null;

  return { lon: x, lat: y };
}

function setScopeUI() {
  const scope = document.querySelector('input[name="scope"]:checked').value;
  const disableBbox = (scope !== 'bbox');
  document.getElementById('minLon').disabled = disableBbox;
  document.getElementById('minLat').disabled = disableBbox;
  document.getElementById('maxLon').disabled = disableBbox;
  document.getElementById('maxLat').disabled = disableBbox;
  document.getElementById('prefSelect').disabled = (scope !== 'pref');
}
document.querySelectorAll('input[name="scope"]').forEach(r =>
  r.addEventListener('change', setScopeUI)
);
setScopeUI();

document.getElementById('prefSelect').addEventListener('change', () => {
  const val = document.getElementById('prefSelect').value;
  const preset = PREF_BBOX[val];
  if (!preset) {
    log('全国（制限なし）を選択しました。');
    return;
  }
  document.getElementById('minLon').value = preset.minLon;
  document.getElementById('minLat').value = preset.minLat;
  document.getElementById('maxLon').value = preset.maxLon;
  document.getElementById('maxLat').value = preset.maxLat;
  log(`都道府県を ${preset.name} に設定しました（BBOX自動適用）。`);
});

document.getElementById('clearBtn').addEventListener('click', () => {
  document.getElementById('geojson').value = '';
  document.getElementById('companyFilter').value = '';
  document.getElementById('downloads').innerHTML = '';
  document.getElementById('log').textContent = '';
});

// ---------- 本体 ----------
document.getElementById('runBtn').addEventListener('click', () => {
  const raw = document.getElementById('geojson').value.trim();
  if (!raw) { alert('GeoJSONを貼り付けてください'); return; }

  let gj;
  try {
    gj = JSON.parse(raw);
  } catch(e) {
    err('GeoJSONのJSONパースに失敗しました。'); return;
  }
  if (!gj || !Array.isArray(gj.features)) {
    err('FeatureCollection（features配列）ではありません。'); return;
  }

  const scope = document.querySelector('input[name="scope"]:checked').value;
  let useBbox = false, minLon, minLat, maxLon, maxLat;

  if (scope === 'pref') {
    const prefCode = document.getElementById('prefSelect').value;
    const preset = PREF_BBOX[prefCode];
    if (preset) {
      useBbox = true;
      ({minLon, minLat, maxLon, maxLat} = preset);
    } else {
      useBbox = false; // 全国
    }
  } else {
    useBbox = true;
    minLon = parseFloat(document.getElementById('minLon').value);
    minLat = parseFloat(document.getElementById('minLat').value);
    maxLon = parseFloat(document.getElementById('maxLon').value);
    maxLat = parseFloat(document.getElementById('maxLat').value);
  }

  const companyFilter = document.getElementById('companyFilter').value.trim();
  const inBbox = (lon, lat) => (!useBbox) || (lon>=minLon && lon<=maxLon && lat>=minLat && lat<=maxLat);

  // 路線ごとにグループ化
  // N02 スキーマ（代表例）: N02_001=事業者, N02_002=路線名, N02_003=駅名
  const lines = new Map(); // key -> { code, name_ja, company, stations: [] }

  let total = 0, used = 0, firstSample = null;
  for (const f of gj.features) {
    total++;
    const p = f.properties || {};
    const pos = extractLonLat(f.geometry);
    if (!pos) continue;

    if (!inBbox(pos.lon, pos.lat)) continue;

    const company = p.N02_001 || p.company || p['会社名'] || '';
    const lineName = p.N02_002 || p.line || p['路線名'] || '';
    const station  = p.N02_003 || p.station || p['駅名'] || '';

    if (!lineName || !station) continue;
    if (companyFilter && !String(company).includes(companyFilter)) continue;

    const key = `${company}__${lineName}`;
    if (!lines.has(key)) {
      const slug = slugify(`${company}_${lineName}`) || 'line';
      lines.set(key, {
        code: slug,
        name_ja: String(lineName),
        company: String(company),
        stations: []
      });
    }
    lines.get(key).stations.push({
      name_ja: String(station),
      lon: pos.lon,
      lat: pos.lat
    });

    used++;
    if (!firstSample) firstSample = { company, lineName, station, lon: pos.lon, lat: pos.lat };
  }

  if (used === 0) {
    if (useBbox) {
      warn('範囲内の駅が見つかりませんでした。都道府県を「全国」へ変更して再実行してください。');
    } else {
      warn('駅が見つかりませんでした。GeoJSONの内容や会社名フィルタをご確認ください。');
    }
  } else if (firstSample) {
    log(`採用サンプル: ${firstSample.company} / ${firstSample.lineName} / ${firstSample.station} @ (${firstSample.lon.toFixed(5)}, ${firstSample.lat.toFixed(5)})`);
  }

  // 路線ごとの重複駅除去・整列
  const lineFiles = [];
  for (const [, line] of lines) {
    const seen = new Set();
    const uniq = [];
    for (const s of line.stations) {
      const k2 = `${s.name_ja}|${s.lon.toFixed(6)}|${s.lat.toFixed(6)}`;
      if (seen.has(k2)) continue;
      seen.add(k2);
      uniq.push(s);
    }
    // 駅名でソート（厳密な運行順はRailway側参照が必要）
    uniq.sort((a,b)=> a.name_ja.localeCompare(b.name_ja,'ja'));

    const lineObj = {
      code: line.code,
      name_ja: line.name_ja,
      company: line.company || null,
      stations: uniq.map((s,idx)=>({
        code: `${line.code}-${String(idx+1).padStart(2,'0')}`,
        name_ja: s.name_ja,
        order: idx+1,
        lon: s.lon,
        lat: s.lat
      }))
    };

    const fileName = `${line.code}.json`;
    downloadJSON(lineObj, fileName);
    lineFiles.push({
      code: line.code,
      name_ja: line.name_ja,
      file: fileName,
      stationCount: lineObj.stations.length
    });
  }

  // index.json を出力（名前順）
  lineFiles.sort((a,b)=> a.name_ja.localeCompare(b.name_ja,'ja'));
  const indexOut = { lines: lineFiles };
  downloadJSON(indexOut, 'index.json');

  log(`総features=${total}, 採用stations=${used}, 路線数=${lineFiles.length}`);
  if (companyFilter) log(`会社フィルタ: "${companyFilter}" を適用しました`);
  log('完了。ダウンロードしたファイルを rail/hiroshima/ へ配置してください。');
});
</script>
</body>
</html>
